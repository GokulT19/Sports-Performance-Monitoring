<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request and message coaches</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

         :root {
             --primary-color: #0077be;
             --secondary-color: #ffa500;
             --background-dark: #121212;
             --text-light: #f4f4f4;
             --gradient-primary: linear-gradient(135deg, #eaecdb 0%, #fdd007 100%);
         }

         * {
             margin: 0;
             padding: 0;
             box-sizing: border-box;
             font-family: 'Poppins', sans-serif;
         }

         body {
             background: rgb(16,16,18);
             background: linear-gradient(108deg, rgba(16,16,18,1) 0%, rgba(1,28,55,1) 100%);
             color: var(--text-light);
             line-height: 1.6;
             overflow-x: hidden;
         }
         .navbar {
             background-color: #121212;
             padding: 1rem 2rem;
             display: flex;
             justify-content: space-between;
             align-items: center;
             position: fixed;
             top: 0;
             width: 100%;
             z-index: 1000;
             transition: background-color 0.3s ease;
             backdrop-filter: blur(10px);
             
         }

         .logo {
            color:#ffa500;
             font-size: 1.8rem;
             font-weight: bold;
             text-transform: uppercase;
             letter-spacing: 2px;
         }
         .loo2-logo {
             display: flex;
             align-items: center;
             justify-content: center;
             font-family: 'Poppins', sans-serif;
             font-size: 2rem;
             font-weight: 700;
             text-transform: uppercase;
             background:white;
             -webkit-background-clip: text;
             -webkit-text-fill-color: transparent;
         }

         .loo2-icon {
             width: 50px;
             height: 50px;
             background: var(--gradient-light);
             border-radius: 50%;
             display: flex;
             align-items: center;
             justify-content: center;
             margin-right: 10px;
         }

         .loo2-icon img {
             width: 70%;
             height: 70%;
         }

         .nav-links {
             display: flex;
             list-style: none;
             gap: 20px;
         }

         .nav-links li {
             position: relative;
         }

         .nav-links a {
             color: var(--text-light);
             text-decoration: none;
             font-weight: 500;
             transition: all 0.3s ease;
             position: relative;
             padding-bottom: 5px;
             margin-right: 20px;
         }

         .nav-links a::after {
             content: '';
             position: absolute;
             width: 0;
             height: 2px;
             bottom: 0;
             left: 0;
             background: var(--gradient-primary);
             transition: width 0.3s ease;
         }

         .nav-links a:hover::after {
             width: 100%;
         }

         .nav-links a:hover {
             color: var(--secondary-color);
             transform: translateY(-3px);
         }

         .dropdown {
             position: relative;
         }

         .dropdown-content {
             display: none;
             position: absolute;
             background-color: rgba(30, 30, 30, 0.9);
             min-width: 200px;
             box-shadow: 0 8px 16px #ffa500;(0,0,0,0.2);
             z-index: 1;
             top: 100%;
             left: 0;
             border-radius: 8px;
             overflow: hidden;
             backdrop-filter: blur(10px);
         }

         .dropdown:hover .dropdown-content {
             display: block;
             animation: dropdownSlideIn 0.3s ease;
         }

         .dropdown-content a {
             color: var(--text-light);
             padding: 12px 16px;
             text-decoration: none;
             display: block;
             transition: background-color 0.3s ease;
         }

         .dropdown-content a:hover {
             background-color: rgba(50, 50, 50, 0.9);
             color: var(--secondary-color);
         }

         .container {
           margin: 50px;
           padding: 50px;
           text-align: center;
         }

         h1 {
           margin-bottom: 20px;
           color: #ffa500;
         }
             h2 {
           text-align: centre;
         }
       /* General Container Styling */
#coach-container {
    background-color: #1e1e1e;
    padding: 40px;
    border-radius: 16px;
    width: 85%;
    max-width: 1200px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    margin: 40px auto;
    margin-top: 120px;
}

h1 {
    text-align: center;
    font-size: 38px;
    margin-bottom: 30px;
    color: #ff9800;
    font-family: 'Arial', sans-serif;
}

/* Coaches List */
#coach-list {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 25px;
}

.coach-card {
    background: linear-gradient(145deg, #292929, #1a1a1a);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    width: 260px;
    text-align: center;
    transition: all 0.3s ease;
}

.coach-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
}

.coach-card h3 {
    font-size: 24px;
    color: #ff9800;
    margin-bottom: 10px;
}

.coach-card p {
    font-size: 15px;
    color: #d4d4d4;
    margin-bottom: 15px;
}

.coach-card button {
    padding: 12px 24px;
    background: #28a745;
    color: #fff;
    font-size: 16px;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.coach-card button:hover {
    background: #218838;
}

/* Popup Styles */
.popup {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.popup-content {
    background: #2c2c2c;
    padding: 30px;
    border-radius: 16px;
    width: 400px;
    max-width: 90%;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.6);
    position: relative;
}

.popup-content .close {
    font-size: 30px;
    color: #ff9800;
    cursor: pointer;
    position: absolute;
    top: 15px;
    right: 20px;
}

.popup-content .close:hover {
    color: #fff;
}

form {
    display: flex;
    flex-direction: column;
}

input, textarea {
    margin: 15px 0;
    padding: 12px;
    font-size: 16px;
    border: 1px solid #444;
    border-radius: 8px;
    background-color: #333;
    color: #e0e0e0;
}

input:focus, textarea:focus {
    outline: none;
    border-color: #ff9800;
    box-shadow: 0 0 5px rgba(255, 152, 0, 0.6);
}

button[type="submit"], .secondary-btn {
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

button[type="submit"] {
    background: #007bff;
    color: #fff;
}

button[type="submit"]:hover {
    background: #0056b3;
}

.secondary-btn {
    background: #444;
    color: #e0e0e0;
    margin-top: 10px;
}

.secondary-btn:hover {
    background: #555;
}

/* Notifications List */
#notifications-list, #replied-list {
    margin: 30px auto;
    width: 85%;
    max-width: 1200px;
}

.notification-card {
    background: #333;
    padding: 20px;
    margin-bottom: 15px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    color: #fff;
    font-size: 16px;
    max-width: 6%;
    align-items: center;
}
hr {
    width: 100%; /* Adjust the width as desired */
    margin: 20px auto; /* Center the line with auto margins */
    border: none; /* Remove default border style */
    border-top: 2px solid #ff9800;
    align-items: flex-start; /* Add a custom color and thickness */
}
    </style>
</head>
<body>
<!-- Navigation -->
<header class="navbar">
    <div class="logo" id="userDetails">Athletes</div>

    <ul class="nav-links">
        <li class="dropdown">
            <a href="athlete.html">Home</a>
        </li>
        <li class="dropdown">
            <a href="#news">News</a>
            <div class="dropdown-content">
                <a href="Allatest-news.html">Latest News</a>
                <a href="trending.html">Trending</a>
            </div>
        </li>
        <li class="dropdown">
            <a href="#events">Events</a>
            <div class="dropdown-content">
                <a href="athleteeventregistration.html">Upcoming Events</a>
                <a href="athleteongoingevents.html">Ongoing Events</a>
                <a href="Allpast-events.html">Completed Events</a>
            </div>
        </li>
        <li><a href="athleteresults.html">Results</a></li>
        <li><a href="athletecoaches.html">Coaches</a></li>
        <a href="athleteprofile.html">Profile</a>
        <li class="notification-icon">
            <a href="athletenotifications.html" class="notification-link">
                <i class="fas fa-bell"></i>
                <span class="notification-dot" id="notificationDot"></span>
            </a>
        </li>
        <li><a href="index.html" id="logoutlink" onclick="logout()">Logout</a></li>
    </ul>
</header>
    <div id="coach-container">
        <h1>Coaches List</h1>
        <div id="coach-list"></div>
    
        <!-- Popup for Notifications -->
        <div id="notification-popup" class="popup">
            <div class="popup-content">
                <span id="close-popup" class="close">&times;</span>
                <h2>Create Notification</h2>
                <form id="notification-form">
                    <input type="hidden" id="coachId" name="coachId">
                    <label for="message">Message:</label>
                    <textarea id="message" required></textarea><br>
                    <button type="submit">Create Notification</button>
                    <button type="button" id="back-btn" class="secondary-btn">Back</button>
                </form>
            </div>
        </div>
    </div>
    
    <h1>My Messages</h1>
    <div id="notifications-list"></div>
    <h1>Coaches Replies</h1>
    <div id="replied-list"></div>
    




</body>
</html>
<script src="tokens.js"></script>
<script src="athleteauth.js"></script>

<script>
    let sessionCheckInterval; // Variable to store the interval

// Enhanced logout function
function logout() {
    // Clear all storage
    localStorage.clear();
    sessionStorage.clear();

    // Clear the interval if it exists
    if (sessionCheckInterval) {
        clearInterval(sessionCheckInterval);
    }

    // Redirect to login page
    window.location.href = 'index.html';
}

// Function to check session validity
function checkSession() {
    const username = localStorage.getItem("username");
    if (!username) {
        console.log("Session invalid: Username not found");
        logout();
    }
}
    const BASE_URL = "http://localhost:8080/api/coaches"; // URL for fetching coaches
    const NOTIFICATIONS_API_URL = "http://localhost:8080/api/coach_notifications"; // URL for notifications API

    // Function to load all coaches
    function loadCoaches() {
        const coachListContainer = document.getElementById('coach-list');
        coachListContainer.innerHTML = ''; // Clear existing coaches

        // Fetch coaches from the API
        fetch(BASE_URL)
            .then(response => response.json())
            .then(coaches => {
                coaches.forEach(coach => {
                    const coachCard = document.createElement('div');
                    coachCard.classList.add('coach-card');
                    coachCard.innerHTML = `
                        <h4>Coach Name</h4><h3>${coach.firstName} ${coach.lastName}</h3>
                         <h4>category:</h3><h3>${coach.category}</h3>

                        <button onclick="openNotificationPopup(${coach.coachId})">Send Message</button>
                    `;
                    coachListContainer.appendChild(coachCard);
                });
            })
            .catch(error => {
                alert('Error loading coaches.');
                console.error(error);
            });
    }

    // Function to open the notification form
    function openNotificationPopup(coachId) {
        const athleteId = localStorage.getItem('athleteId');

        if (!athleteId) {
            alert('Athlete ID not found in local storage.');
            return;
        }

        document.getElementById('coachId').value = coachId;
        document.getElementById('notification-popup').style.display = 'flex';
    }

    // Function to close the notification popup
    document.getElementById('close-popup').addEventListener('click', () => {
        document.getElementById('notification-popup').style.display = 'none';
    });

    // Handle form submission for creating notification
    document.getElementById('notification-form').addEventListener('submit', function(event) {
        event.preventDefault();

        const athleteId = localStorage.getItem('athleteId');
        const coachId = document.getElementById('coachId').value;
        const message = document.getElementById('message').value;

        if (!athleteId) {
            alert('Athlete ID not found in local storage.');
            return;
        }

        // Send the notification to the server (POST request)
        fetch(`${NOTIFICATIONS_API_URL}/create?athleteId=${athleteId}&coachId=${coachId}&message=${encodeURIComponent(message)}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            alert('Notification created successfully!');
            loadNotifications(); // Reload notifications after submitting the form
            document.getElementById('notification-popup').style.display = 'none'; // Close popup
        })
        .catch(error => {
            alert('Error creating notification.');
            console.error(error);
        });
    });

    // Function to load notifications for the current athlete
    function loadNotifications() {
        const athleteId = localStorage.getItem('athleteId');

        if (!athleteId) {
            alert('Athlete ID not found in local storage.');
            return;
        }

        fetch(`${NOTIFICATIONS_API_URL}/athlete/${athleteId}`)
            .then(response => response.json())
            .then(async (notifications) => {
                const notificationsListContainer = document.getElementById('notifications-list');
                notificationsListContainer.innerHTML = ''; // Clear existing notifications

                if (notifications.length === 0) {
                    notificationsListContainer.innerHTML = '<p>No notifications found.</p>';
                    return;
                }

                // Fetch athlete and coach names concurrently
                const athletePromises = notifications.map(notification =>
                    fetch(`http://localhost:8080/api/athletes/${notification.athleteId}`)
                        .then(res => res.json())
                        .then(data => `${data.firstName} ${data.lastName}`)
                        .catch(() => 'Unknown Athlete')
                );

                const coachPromises = notifications.map(notification =>
                    fetch(`http://localhost:8080/api/coaches/${notification.coachId}`)
                        .then(res => res.json())
                        .then(data => `${data.firstName} ${data.lastName}`)
                        .catch(() => 'Unknown Coach')
                );

                const athleteNames = await Promise.all(athletePromises);
                const coachNames = await Promise.all(coachPromises);

                notifications.forEach((notification, index) => {
                    const messageBlock = document.createElement('div');
                    messageBlock.classList.add('notification-message');

                    messageBlock.innerHTML = `
                        <div class="message-sender"><strong>Sender (Athlete):</strong> ${athleteNames[index]}</div>
                        <div class="message-receiver"><strong>Receiver (Coach):</strong> ${coachNames[index]}</div>
                        <div class="message-content"><strong>Message:</strong> ${notification.message}</div>
                        <hr />
                    `;

                    notificationsListContainer.appendChild(messageBlock);
                });
            })
            .catch(error => {
                alert('Error loading notifications.');
                console.error(error);
            });
    }

    // Function to load replied notifications
    function loadCoachReplies() {
    const athleteId = localStorage.getItem('athleteId');

    if (!athleteId) {
        alert('Athlete ID not found in local storage.');
        return;
    }

    fetch(`${NOTIFICATIONS_API_URL}/athlete/${athleteId}`)
        .then(response => response.json())
        .then(async (notifications) => {
            const repliedListContainer = document.getElementById('replied-list');
            repliedListContainer.innerHTML = ''; // Clear existing replied notifications

            // Filter notifications with status 'REPLIED'
            const repliedNotifications = notifications.filter(notification => notification.status === 'REPLIED');

            if (repliedNotifications.length === 0) {
                repliedListContainer.innerHTML = '<p>No replies from coaches found.</p>';
                return;
            }

            // Sort replied notifications in descending order by timestamp
            repliedNotifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Fetch coach names concurrently
            const coachPromises = repliedNotifications.map(notification =>
                fetch(`http://localhost:8080/api/coaches/${notification.coachId}`)
                    .then(res => res.json())
                    .then(data => `${data.firstName} ${data.lastName}`)
                    .catch(() => 'Unknown Coach')
            );

            const coachNames = await Promise.all(coachPromises);

            // Generate the HTML for replied notifications
            repliedNotifications.forEach((notification, index) => {
                const replyBlock = document.createElement('div');
                replyBlock.classList.add('reply-message');

                replyBlock.innerHTML = `
                    <div class="reply-coach"><strong>Coach:</strong> ${coachNames[index]}</div>
                    <div class="reply-content"><strong>Your Message:</strong> ${notification.message}</div>
                    <div class="reply-content"><strong>Coach Reply:</strong> ${notification.coachReply}</div>
                    <hr />
                `;

                repliedListContainer.appendChild(replyBlock);
            });
        })
        .catch(error => {
            alert('Error loading coach replies.');
            console.error(error);
        });
}


    window.onload = function() {
        loadCoaches();
        loadNotifications();
        loadCoachReplies();
    };

    // Back button for the popup
    document.getElementById('back-btn').addEventListener('click', () => {
        document.getElementById('notification-popup').style.display = 'none';
    });

</script>
</body>
</html>